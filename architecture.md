# Архитектура компьютера

_Романишин Виктор Васильевич_

> Архитектура компьютера изучает **логическую** организацию и структуру аппаратных ресурсов вычеслительной системы. Связана с **программными** аспектами, а не аппаратными.

> Структура - совокупность разного.

Аспекты реализации компьютерной системы не являются частями архитектуры.


## Виртуальный компьютер

## Процессор

> Центральный процессор общается **исключительно** с памятью. 

> С устройствами процессор общается через **окно в оперативной памяти**

> Любая программа должна быть целиком расположена в оперативной памяти.

> Так как двоичный код поддерживает и математические, и логические операции, он стал основой компьютерных систем.

> В компьютерной логике 0 даже не рассматривается. (Изучаются только 1 (истинна)). Все функции, преводящие к 0 сокращаются.

> Математические и логические операции являются бинарными (кроме not).

> BYTE = WORD = разрядность шины процессора. Начиная с 60-x — 8 BIT.

> Современное WORD - DWORD - 16 BIT.

> В момент компиляции программы весь исходный код представляется в виде непрерывного потока команд, где каждая команда имеет свою позицию в памяти, каждая переменная заранее определяется в памяти

Процессор:
- АЛУ (Арифметически-Логическое Устройство) — Исполняет математические и логические операции. `+/-* >< == != not and or xor`.
  - Процессор умеет только складывать.
  - Памяти не имеет, но
  - Обладает собственными регистрами для обработки данных и хранения операндов.
- ОЗУ (Оперативно-Запоминающее Устройство) — 8-Битные ячейки памяти, где каждая ячейка имеет порядковый номер и количество ячеек зависит от разрядности шины адреса.
  - Структура представляет из себя таблицу.
  - Процессор работает не с данными, а с адресами ячеек. (Операции над адресами)
  - Самый медленный 
  - Имеет иерархическую структуру
    - Регистры - Сверхбыстрая память (1 такт)
- Шина адреса — служит указателем на ячейку. В один момент времени может быть открыта только одна ячейка.
- Шина данных — служит дорогой для доставки данных в ячейки. Размер — DWORD. Т.е. работа происходит с двумя ячейками (в одновременном или последовательном режиме).
  - Размер определяет сложность компьютерной системы.
  - Показывает, сколько информации можно передать за один такт.
  - Размерность шины адреса и шины данных может не совпадать.
- Шина управления
- УУ (Устройству Управления) — взаимодействует с шиной управления, обеспечивает **автоматическое** выполнение математических операций.
  - Служит т.н. интерпретатором, расписывающим математические действия на более низкоуровневые операции (с использованием сложения и битовых сдвигов).
- Тактовый генератор - Управляет всеми. Задаёт время на выполнение каждой операции на основе самого слабого звена.


### Д/З

- Определения: процессор, сопроцессор, контроллер, шины (все три)
- Представление и кодирование данных в компьютерной системе

## Компьютерная арифметика

### Представление данных и числе в компьютерной системе

У каждого узла компьютерной системы есть собственные регистры

Объём регистра = WORD (согласно разрядности процессора)

Регистры группируются по 4 бита

Каждый регистр имеет собственное имя, поэтому им не нужны адреса

Двоичный код = двоичное число + знак
- Прямое число (unsigned)
- Прямой код (signed)
- Обратный код = ~прямой код
- Дополнительный код (наиболее распространённый код представления отрицательного числа), ибо всегда имеет дополнительную единицу = Обратный код + 1

#### Представление чисел с запятой

- fixed [sign|int|fract]
- float [знак|порядок|мантиса]

IEEE - всемирная организация стандартизирования всего, что связано с радиоэлектроникой

> IEEE754 - Стандарт представления чисел с плавающей запятой

У двоичного кода есть одно интересное свойство:
- При проведении инверсии числа, оно станет отрицательным
- (2 - 4) = (2 + ~4 + 1)

### Алгебра логики

- Минимальный процессорный комплект — 35 команд
- Стандартный комплект — 50-130 команд
- Универсальный комплект — 900 команд

Базовые логические функции:
- AND - A && B 
- OR
- NOT - Ã = !A
- XOR = (!A && B) || (A && !B)
- Импликация = A => B = [0 -> 1 = 0] = !(!A && B)
- Эквивалентность = NOT XOR
- Мажоритарка = (Sum / Len) > 0.5

Теория $1 Шефера и $2 Пирса: всё можно построить из $1 (NOT и AND) $2 (NOT и OR)

Числа с плавающей запятой должны быть целыми, чтобы с ними можно было выполнять операции. Для этого запятую сдвигают так, чтобы вся информация была в целой части, а размер сдвига указать в мантисе.

Половинная точность

```
| Знак |  Порядок  | Признак запятой |     Мантиса       |
|  F   | E D C B A |                 | 9 8 7 6 5 4 3 2 1 |
```

Single

```
Знак | Порядок  |                       Мантиса                      |
20   | 19 18 17 | 16 15 14 13 12 11 10 F E D C B A 9 8 7 6 5 4 3 2 1 |
```

Double

```
Знак | Порядок  | Мантиса |
40   | 3e - 34  | 51 - 0  |
```

Порядок +, мантиса \*

#### Правило двоичного сложения

- 0 + 0 = 0;
- 0 + 1 = 1;
- 1 + 0 = 1;
- 1 + 1 = 10;

```
  00000001
+ 00000001
  --------
  00000010
```

Полусуматор:

```python
def halfsum(a, b):
    return (a ^ b, a & b)
    #        value, carry-out
```

```python
def fullsum(a, b, carryout=0):
    v, c = halfsum(a, carryout) # ?
    return halfsum(v, b) # ?
```

Разряд результата = сумма разрядов чисел

> Обратный код = ~код

> Дополнительный код = ~код + 1 и он **всегда отрицательный**

### Двоичный компаратор

Выполняет 3 действия одновременно:
- A == B
- A < B
- A > B

1. XNOR
2. AND NOT

4-битный компаратор

```
A
---|-[XOR]
-|-|-[   ]-[NOT]-- C (A == B)
B| |
 | |-----[AND]---- D (A > B)
 -[NOT]--[   ]
```

```python
def comp(a, b):
    return (int(not (a ^ b)), int(a and (not b)))
```

(101) <=> (110) => 

```
1-[COMP]-1------|
1-[    ]-0---------------------[AND]----|
                |                       |
0-[COMP]-0------| (Для ==)              |        ----------- (A == B)
1-[    ]-0---------------------[AND]----|-[OR]---|-[  ]
                |-[AND]----------------------------[OR]----- (A > B)
1-[COMP]-0------|                       |        |
0-[    ]-1---------------------[AND]----|        ----------- (A > B)
                |                       |
 -[COMP]--------|                       |
 -[    ]--------------------------------|
```

```python
def comp4x((a1, a2, a3, a4), (b1, b2, b3, b4)):
    tmp1 = comp(a1, b1)[0] and comp(a2, b2)[0] and comp(a3, b3)[0] and comp(a4, b4)[0]
    tmp2 = (
           (comp(a1, b1)[1] and comp(a2, b2)[0] and comp(a3, b3)[0] and comp(a4, b4)[0])
        or (comp(a2, b2)[1] and comp(a3, b3)[0] and comp(a4, b4)[1])
        or (comp(a3, b3)[1] and comp(a4, b4)[0])
        or comp(a4, b4)[1]
    )

    return (
        tmp1,
        not (tmp1 or tmp2),
        tmp2
    )
```

### Очерёдность выполнения логических функций

0. ()
1. NOT
2. AND
3. OR
4. IMP
5. EQ

> Закон Де Моргана: & = !| <=> !& = |

## Регистры процессора

- `+` - XOR
- `*` - &

> Процессор не имеет собственной памяти

Невозможно одновременно получить доступ к нескольким ячейкам, поэтому нужен посредник, который бы предоставлял молниеносный доступ к временным данным - регистры

> Процессор - то, что производит вычислительные процессы.

> Регистр - временное хранилище данных для операндов, с которыми работает процессор.

- Используются **всеми** контроллерами, сопроцессорами и процессорами в системе.
- Мин. размер регистра = WORD (int16)
- Разделяются на группы кратные 4x
- Не имеют собственного адреса, только порядковый номер
- Находятся с процессором на одном кристале
- Работают со скоростью узлов процессора

16bit регистр A:
- AH 8bit
- AL 8bit

Типы регистров:
- Регистры Общего Назначения (max 500 in ARM)
- Регистры Специального Назначения (невозможно изменить вручную)
- Регистры Признаков
  - Служит для контроля работы системы
  - Каждый бит имеет имя, которое называется флагом
  - Изменяются либо командой, либо результатом работы команды

> Все регистры имеют возможность сдвига данных SR >> SL <<

Сдвиг выполняется за 1 такт

При сдвиге, число может выйти за размер регистра

> Регистр включается только тогда, когда появляются данные.

```
-[CLK | RG |  ]
-[----|    |  ]
-[S0  |<-->|QA]-
-[S1  |    |QB]-
-[----|    |  ]
-[SR  |    |QC]-
-[SL  |    |QD]-
-[A   |    |  ]
-[B   |    |  ]
-[C   |    |  ]
-[D   |    |  ]
-[°CLR|    |  ]
```

- CLK - Синхроимпульс тактового генератора
- S0, S1 - Управляющие ножки. Переключают режим работы регистра
  - 0 0 - Хранение (не реагирует ни на что)
  - 0 1 - Разрешён сдвиг влево
  - 1 0 - Разрешён сдвиг вправо
  - 1 1 - Запись в выходы
- SR, SL - Сдвиг
  - Бит, которым заменить верхний/нижний бит, выталкивая остальные
- A, B, C, D - Входы
- CLR - Сбрасывает весь регистр (сигн. 0)
- Входы подключены к шине данных
- Выходы запаралеленны и подключены к процессору (АЛУ)

> Триггер - бистабильная ячейка (0/1)

Для последовательной передачи данных тоже используются регистры

## Архитектура команд процессора

Команды процессора оперируют лишь адресами (в явной или неявной форме)

Явное указание адреса (28 бит/команду)

- Код команды
- A
- B
- C

Используется только в микроконтроллерах, в которых ОЗУ работает с частотой процессора, иначе память конкретно тормозит выполнение.

Неявное указание адреса

- Код команды
- Метод адресации
- A
- B
- C

- Команды арифметических операций над числами с фиксированной и плавающей точкой
- Команды десятичной арифметики (каждая десятичная цифра представлена четырёхзначным двоичным кодом)
- Команды логических операций
- Команды передачи кода (регистр-регистр, регистр-память, память-регистр)
- Команды операций ввода-вывода
- Команды передачи управления
- Команды управления потоком команд
- Команды выполнения условий
- Команды задания режима работы компьютера


Структура команды определяется составом, назначением и количеством полей

Формат команды определяет структуру команды, указанием границ команды, границы отдельных полей команды и указанием числа бита полей команды

Базовые типы набора команд:
- [CISC] Complex Instuctions Set Computer - Архитектура с полным набором команд (до i386)
  - Появились как следствие использования языков высокого уровня
  - Каждый оператор высокоуровневого языка имеет мнемонику в списке команд CISC процессора
  - Как следствие, количество команд перевалило за 200 (сейчас почти 900)
  - **Минусы CISC инструкций**
    - Сложность
    - Большое количество тактов (>4)
    - Разнотипные (нельзя выполнять параллельно)
    - Их дохрена
  - **Плюсы CISC инструкций**
    - Программы легко переносятся на новые платформы
  - Решения
    1. Присвоение каждому действию конструкции в виде логических микросхем
    2. Программирование ПЛИС (программирование логической интегральной схемы)
      - Программируя всего один модуль, мы обслуживаем все инструкции
      - Для обслуживания каждой команды, ПЛИС содержит код операций
      - **Минусы ПЛИС**
        - Ни одна команда не может быть выполнена за один такт
        - Невозможно создать вычислительный конвейер
        - Команды выполняются долго
        - Команды имеют разную длину выполнения
- [RISC] Процессор с ограниченным количеством команд (<=50)
  - Все CISC команды представлены в виде алгоритма
  - Команды имеют одинаковую размерность и время выполнение
  - Характерно появление конвейера, когда команды выполняются одновременно
  - Основная работа происходит с регистрами, от чего регистров этих дохрена (до 500)
  - **Плюсы RISC инструкций**
    - Компактность
    - Параллелизм
    - Многоядерность

> i486 пытались объеденить CISC + RISC, а полного слияния они достигли в Pentium

В процессорах-гибридах, CISC-команда детектируется и разбивается на множество RISC-команд

## Упакованные данные (SSE)

В одной команде содержится до четырёх блоков данных. (VLIW - Very Long Instructions W*alk?*)

Данная философия позволяет обрабатывать мультимедийные, потоковые и однотипные научные данные.

Минус: нельзя пропускать слова

Все преимущества данной архитектуры проявляются только при компиляции.

Длина инструкции SSE - 128 бит

MMX, SSE

## Архитектура процессорной памяти

- Аккумуляторная архитектура (не требует указания адреса 
  - Регистровая архитектура 1964 г. Cray (регистровый файл) [регистр-память, память-регистр]
    - Выделенный доступ к памяти 1976 суперкомпьютер Cray
      - RISC [регистр-регистр]
        - Very Long (Intel ® Itanium) 1990 г.
    - CISC (Intel ® VAX) 1977 г.
- Стековая стековая 1963 г. (можно реализовать как аппаратно (стек регистров), так и программно (кусок памяти/блок регистров перевести в стек)
  - Безоперандная архитектура 2001 г. (для малых RISC процессоров)

Базовые варианты хранения операндов:
- Стек (тек регистров)
- Аккумулятор (выделенный регистр для одного операнда, в который заносится и результат)
- Регистры (массив регистров, регистры общего назначения РОН, особенно распространена в RISC)
- Выделенный доступ к памяти (самый медленный, используется в микроконтроллерах)

Регистр-регистр:
- Плюсы:
  - Маленький фиксированный размер команды
  - Легко компилируется
  - Все команды выполняются за одинаковое количество тактов
- Минусы:
  - Увеличение кода ~30%

Примеры:
1. Польская нотация
  - push a
  - push b
  - add
  - pop result

LOAD -> Аккумулятор
STORE Аккумулятор -> RAM

Для уменьшения адресности команды используется косвенная адресация.

- Код операции
- Способ адресации
- Адрес содержимого ячейки

> Счётчик команд - регистр, хранящий положение текущей команды

Базовая регистровая адресация - хранит полноразрядный адрес в регистре адреса (БРА).

- Сумматор
- Множитель
  - Алгоритмический
  - Логический
- Преобразование

Архитектура команд предоставляет интерфейс процессора к устрйству управления.

Типы команд ассемблеров
- Инструкции
- Служебные команды (как вести себя компилятору)

Командный интерфейс отвязан от аппаратной реализации (с точки зрения программиста).

Привязка идёт не к процессору, а к его системе команд.

1. Устройство управления - аппарат конечного состояния


Параметры необходимы для
- Определения способа адресации (>70% кода переносят данные)
  - Без параметров
    - Стек
    - Аккумулятор
    - Команда

Обобщения
- Информация в компьютере делится на данные и команды
- Команды указывают компьютеру, какие действия выполнить над данными
- Последовательное выполнение команд называется программой (поток команд и операндов)
- Весь набор выполняемых компьютером команд называется системой команд
- Команды и данных хранятся в одной памяти в двоичном виде
- Команды и данных хранятся в памяти по адресам
- Память имеет свободную адресацию (RAM)
- Память является линейной
- Кеш I уровня содержит 2 потока: данных и команд

CISC:
- Арифметические действия кодируются в одной команде
- Небольшое количество регистров, каждый выполняет определенную функцию (~8)
- Команды могут быть плавающей длины
- УУ имеет программную логику
- Различных форматы команд с разной длиной
- Базовая двухадресная адресация
- Очень развитый механизм адресации операндов

RISC (идея 1975, релиз 1980)
- Сокращённый набор команд
- Максимально простая система управления командами
- Одна команда - один такт
- Полная унификация микрокода (размер и параллельность)
- Для эффективного управления системой было добавлено большое количество регистров (до 500)
- Основная схема работы: R/R
- Все длины инструкций стандартизированы
- IO использует только R/R
- Полное отсутствие микропрограмм внутри процессора (только команды состояний)
- До 128 команд
- Любую CISC команду можно составить из простых RISC команд
- Современные CISC процессоры используют RISC ядро (Pentium 1+)

## Шутки от Романишина

- Секта свидетелей ЦПУ.
- Если у вас много оперативки — добавьте ещё.
- 90x60x90-нанометровый техпроцесс.
- Мы совершили революцию в медицине — научились удалять гланды через задний проход.