# Конспект по дисциплине «Операционные системы»

*Романишин В.В. [e-mail](Romanishin.VIKTOR@ukr.net)*

## Тема: ПО компьютерных систем и классификация ПО *([Облако](#TODO))*

Программное обеспечение
- Системное ПО
  - Базовое ПО (**BIOS** - **B**asic **I**nput **O**utput **S**ystem)
  - Операционные системы
    - Файловые системы
    - Драйвера (**H**ardware **A**bstraction **L**ayer) - Абстрагируют железо
  - Служебные утилиты
    - Улилиты
    - Антивирусные средства
- Прикладное ПО
  - Специализированное ПО - Создание файлов
    - Профессиональное ПО
    - Пользовательское ПО
  - Универсальное ПО - Без возрастных цензоров
    - Браузеры
    - Казуальные игры
    - Просмотрщики / плееры
- Инструментальные средства - Программы, создающие программы
  - IDE (**I**ntegrated **D**eveloper **E**nvironment)
    - Проверка синтаксиса
    - Пошаговое исполнение
    - Отладка
  - Компиляторы
  - Трансляторы

Базовые функции :
- **POST** контроль (**P**ower **O**n **S**elf **T**est) - Проверяет электропитание.
- Будит южный и серверный мосты, чтобы оживить процессор.
- Проверка регистров процессора, заполнение их 0-ми.
- Тестирование RAM, копирование в неё POST коды [0, 1024]кб.
  - Быстрый тест (Fast test) - Счёт количества ячеек памяти и записать её во Flash.
  - Полный тест - Тестирование чтения/записи ячеек
- Копирование данных BIOS в RAM.
- Передача управления процессору. Микроконтроллер лишь сделит за напряжением.
- Тестирование подключения клавиатуры.
- Тестирование портов, поиск устройств.
- Инициализация контроллеров подключённых жёстких дисков.
- Поиск загрузчика ОС в активной области **MBR** (Master Boot Record).

*Все токи задаются программно, с помощью мультиконтроллера*

*Существует специальный **BIOS** - **EFI** (Extended Firmware Interface) ©Intel,
он предоставляет доступ к мультиконтроллеру из ОС.
**UEFI** (Universal EFI) - OpenSource разработка*

*ACPI (**A**dvanced **C**ontrol **P**ower **I**nterface)*

```
|------------|    |--------------------------------|    |------------|
|            |    | Мулитиконтроллер (мультик).    |    |            |
| Южный мост | <- | Контролирует каждое устройство | <- | ROM с BIOS |
|            |    | в системе                      |    |            |
|------------|    |--------------------------------|    |------------|
```

**Бистабильная ячейка** - boolean. Но при старте значение неизвестно. Set - 1, reset - 0

> Если не учиться - лучше вообще не учиться. © Виктор Романишин

<!---->

```
Программы     Юзверь
    |           |
   API       Интерфейс
    |           |
Операционная система
         |
Слой абстракции (Драйвера)
         |
Аппаратное обеспечение
```

*API - **A**pplication **P**rogram **I**nterface*

API:
- WIN32
- GTK
- Qt
- wxWidgets

Первый полноценный 8-разрядный компьютер определил размер байта.
Разрядность процессора определяет Размер байта соответствует размеру адресной шины.

Функции операционной системы:
- **Выполнение низкоуровневых действий по запросу пользователя.**
- **Загрузка программ в оперативную память и их выполнение.**
- Стандартизированный доступ к периферийным устройствам.
- Распределение оперативной памяти между процессами и организация виртуальной памияти.
- Управление доступом к носителям информации и файловым системам.
- Отображение интрефейса пользователя.
- Сетевые операции и поддержка стека сетевых протоколов.
- Многозадачность.
- Распределение процессов между процессами.
- Защита памяти от несанкционированного доступа.
- Взаимодействие между процессами.
- Защита от других пользователей (если поддерживает ФС).
- Многопользовательский интерфейс (ОС) и распределение прав доступа (ФС).

*Размер блока: 512 байт.*

**NFS** *(Network File System)* - Файловая система, которая разбита между серверами.

Оперативная память - одна на всех.

<!---->

Понятия в операционных системах:
- Процесс - программа, загруженная и исполняемая в памяти. Могут взаимодействовать только с оперативной памятью.
    - Адресное пространство - То, что выделяется процессу один раз. Там находятся указатели на используемые переменные
      - Выгружаемая     - Может расширяться. Здесь могут храниться данные программы.
      - Не выгружаемая  - Нельзя трогать ни при каких обстоятельствах.
    - Открытые файлы
    - Поток - Некий независимый подпроцесс. Процесс состоит из нескольких потоков.

Режимы работы ядра:
- Режим ядра (real mode)            - Привелегированный режим доступа к оборудованию. Пошло от CISC 18086, который имел полный доступ к ОЗУ (<=1Мб).
- Пользовательский (protected mode) - Не имеет прямой адресации и прямого доступа к железу.
                        В этом режиме исполняются пользовательские программы.
                        Пошло от i80586.

**Переключение контекста** (переключение между режимами работы ядра) - длительный процесс, при котором происходит полная остановка программ,
        складывание содержимого процессора в стек, очистка всех регистров и передача управления программе,
        которая запросила реальный режим, при этом, отпадает вся многозадачность.
    Является переключением режима работы самого процессора, на определенное время он забывает про существование виртуальной оперативной памяти и начинает работать с реальной.
    Является крайне нежелательным приёмом в программировании, так как тормозит всю систему.

Отбор TLB - модель поведения процессора, когда он предугадывает действия программ, отсылая им результат до того, как они его запросили. Эта информация хранится в кеше 2-го и 3-го уровня. Ассоциативная память. Это выполняет блок TLB.

Каждое устройство имеет своё окно в адресном пространстве. Так же, там находится программа-обработчик, которая знает, как общаться с железом.

80386 - Первый 32-битный процессор.

> "Ввести цианистый калий в рафинаде" © Виктор Романишин

Бирус - вирус для BIOS, который физически уничтожает устройства на материнской плате.


**MMU** (**M**emory **M**anagement **U**nit) - Модуль процессора, который указывает физическую границу раздела реальной и виртуальной памяти.

```
|---------------------|------------|--------------------|
| Прямая адресация    |Непроходимый| Виртуальная память |
|                     |----забор---|--------------------|
|---------------------|------------|--------------------|
```

Доступ в прямую адресацию только через посредников, например, через Internet Explorer.

Полное адресное пространство - 4 Гб.

Каждой программе выделяется виртуальное адресное пространство, начинающиеся с нуля.

1-4 кб - размер страницы памяти. Номер страницы заносятся в кеш MMU.

> "MMU его знает" © Виктор Романишин

**Своппинг** - процесс обмена страницами памяти оперативки со SWAP файлом.
При этом, адреса страниц не меняются, а, вместо этого меняется их местоположение.

> "У динозавров было два мозга. Часть мозга в заднице, который отвечает за двигательные движения." © Викто Романишин

<!---->

2 ^ битность процессора - количество адресов

A0011 - Реальное адресное пространство, где находится информация для запуска системы. (BIOS)

Части адресного пространства:
1. Адреса прерываний Векторы прерывания для адра и старта систем + обработчики (0-15, но сейчас больше)
2. Загрузчик ОС и ещё компоненты (первые 640кб)
3. Верхняя память для драйверов, которые позволяют увидеть то, что находится дальше
 - 128кб - Часть BIOS для тестирования устройств на программном уровне.

Макс на реальные адреса - 2 Гб, а дальше будет размечаться по другому принципу (пользовательская зона, защищённый режим).


Ядро, находящееся в реальных адресах (в режиме ядра) не может изменять свою структуру - Невыгружаемая часть ядра.

Основные функции ядра:
1. Обработка прерываний (Обеспечивают многозадачность, обрабатывают запросы от устройств и программ)
  - Незапланированные прерывания    - Асинхронные события
  - Запланированные прерывания      - Синхронные события
2. Механизм обращения к ядру
3. Создание/уничтожение процессов
  - При создании процессов выделяется память в пользовательском режиме
  - Все процессы должны быть изолированы
4. Переключение состояния процессов
5. Диспетчеризирование
6. Остановка и возобновление процессов
7. Взаимодействие между процессами
8. Ввод-вывод
9. Распределение и перераспределение памяти
  - Разделение памяти на страницы
  - Организация виртуальной памяти
  - Swapping страниц памяти
10. Поддержка работы файловой системы
11. Вызов процедур и возвращение результата
12. Поддержка ведения логов

Типы ядра:
- Монолитное - все части в одном адресном пространстве (Unix, DOS)
  - + Скорость работы
  - + Простота разработки модулей
  - - Елиное адресное пространство
  - - Невозможность подгрузки модулей
  - - Невозможность замены апаратного обеспечения
  - - Компиляция только под конкретную версию процессора
- Модульное - Современное улучшение монолитного ядра
  - Главное достоинство - вынос части модулей за пределы ядра, при этом, находясь в том же адресном пространстве.
  - + Не требуется перекомпиляция при замене модулей
  - + Возможность смены драйверов
  - + Возможность динамической подгрузки модулей
  - - Уменьшается скорость работы
- Микроядро - Предоставляет только элементарные функции управления процессами и минимальный набор абстракций для управления железом.
  - Большая часть работы происходит под управлением пользовательских процессов - **сервисов**
  - Выносятся критические процессы и драйвера
  - Работа в режиме **Клиент - Сервер**
  - - Немного уменьшается быстродействие системы
  - - При добавлении новых процессов, требуется перекомпиляция ядра
  - - Маленький набор низкоуровневых примитивов
  - - Большие затраты при передаче данных между процессами
  - + Занимает очень мало памяти
  - + Высокая стабильность и стойкость к сбоям
  - + Высокая степень модульности ядра
  - **Примеры**
    - Некоторые версии \*nix (Используют демоны)
    - Windows NT
    - Windows CE
    - Mach
- Экзоядро
- Гибридное ядро - Модификация модульного ядра
- Наноядро - Используется для микроконтроллеров
  - Реализована только функция управления прерываниями

Подсистема окружения - API для программ

Windows имеет поддержку подсистем окружения из ОС:
- \*nix
- Ms DOS
- Win32
- Win16
- WinNT
- etc.

\*nix имеют трансляторы:
- Wine (free)
- Crossover (proprietary)



Программам выделяются страницы памяти

Виртуальная память разбивается на страницы (сегменты)
Без виртуальной памяти невозможна многозадачность

В x86 процессорах размерность страницы: 2-4кб.
В Linux - 4кб.

Максимальный объём страницы памяти: 2 ^ 16 = 65536 (64 кб)
1 слово (DWORD) = 16 bit

$ - HEX

pageno * pagesize + base + offset

base хранится в регистре


## Файловые системы

Все диски - блочные устройства (данные передаются блоками по 512 байт)

Любое устройство обменивается информацией блоками (блочные устройства), любое устройство, имеющие кэш тоже к ним относится.

Нельзя форматировать сырые носители, ибо не известно ни начала памяти, ни конца, поэтому, создаётся раздел.

Разметка носителя информации необходима для создания разделов на носителе информациии нанесения формата файловой системы на раздел.

Сектор #0 (512 байт) - MBR *(Master Boot Record)* выделен под данные про количество и размеры разделов на носителе.

В MBR можно поместить:
  - Разделы, максимум - 4 раздела
  - Ссылка на загрузчик ОС
  - Ссылка на раздел с ОС (активный основной раздел)

Максимальные адреса - 2.2 Тб

Для увеличения размена, размечается как расширенный и помещается, в основном, в конец.

Внутри расширенного раздела находится сектор, аналог MBR, но он позволяет создать любое количество логических разделов.

При формировании раздела, ему даётся униальный ID.

При наличии разделённого загрузчика, ОС может находиться в любом разделе, как логическом, так и в физическом и даже в файле.

После разметки диска на разделы, в разделах может находится любая файловая система.

MBR:
    - Загрузчик ОС (0x7C00)
GUIP Partition Table - Неотъемлимая часть UEFI - Замена MBR, но совместима с ним. Не содержит логических размеров, так как нет ограничения на размер раздела. Находится в разных частях диска для надёжности. Количество разделов не ограничено, но ограничено искуственно 128-ю. 9.4 ЗБ (зетабайта). Должен быть специальный раздел System EFI (**FAT32**).
    - Таблица устройств (ACPI Table/AML Table) - Управление питанием, сон и другой доступ к устройствам из ОС.
    - Windows Recovery Partition (NTFS ~300Mb) - Windows-specific раздел, указывает на систему ререзвирования.
    - Стрёмный секретный зашифрованный MSR (NTFS ~16Mb)

Legacy Mode - Признак доступности GUIP

Boot Security => Загрузчик полностью находится в UEFI.

### Файловые системы

Родные ФС для ОС:
  - Win
    - NTFS (x64)
    - FAT16+
  - \*nix
    - EXT(2-4)
    - ReiserFS (Хорошо подходит для работы над кучей мелких файлов)
    - JFS
  - MacOS
    - HPFS

Поддерживаемые ФС для ОС:
  - Win
  - \*nix
    - FAT
    - NTFS
  - MacOS
    - FAT
    - NTFS (только чтение)

## Five years later

- Блочные устройства (носители информации, трансляторы) - Логический диск
  - Размер блока: 512 байт
- Битовые устройства (клав. мыши)

Разделение диска на разделы

Стиль разметки:
- MBR (Master Boot Record):
  - [0] = информация по разделам len(512 байт)
  - max - 2.2 Тб разделов
  - 4 основных раздела
  - информация про активный раздел
  - в каждом разделе может храниться расширенный раздел (лучше ставить последним)
- UEFI (Universal EFI):
  - GPT (GUI Partition Table) [Обратно совместим с MBR]
    - Имеет зеркало таблицы разделов
    - Отличия от предыдущей системы:
      - 9.4 зетабайта
      - все разделы основные
      - 128 разделов
    - Разделы:
      - Главный раздел:
        - FAT32 
        - "System EFI"
        - Хранит ACPI таблицы
        - \*.efi - Генерируется или ОС, или производителем
    - Windows:
      - Первый раздел [100 Мб]
      - [NTFS] Раздел Windows Recovery [300 Мб]
      - [MSR] Шифрованный раздел с хрен-знает-чем [16 Мб - 128 Мб]
      - [NTFS] Windows


Загрузчики:
  - Windows 7
    - NT Loader
  - Windows 8+
    - Boot Manager (bootmrg)

> GRUB состоит из 5 частей.

NTFS (x64) [FT]

> Для уменьшения количества адресов файловой системы, мы объединяем физические сектора в логические группы (кластеры [лат. гроздь]), в которых сектора стоят последовательно.

Оптимальный размер - 8 сек/кластер (4 Кб) (max - 64 Кб)

Max(FAT16) - 2 Gb  [Win]; Limit(FAT16) - 4 Gb
Max(FAT32) - 32 Gb [Win]; MaxClusterSize(32 Кб); Limit(FAT32) - 2 Tb
extFAT {Очень экономно убивает флешку}
NTFS - Журналируемая ФС; Хранит мета-данные [MFT]; Все права и шифрование заключены в атрибутах файла {Нужно оставлять 25% свободного места, чтобы не происходила фрагментация}

"Выполнение" у каталога - запрет на просмотр файлов

> DMI - микросхема, описывающая все характеристики устройств, которые должен активировать BIOS.

Между первым запросом и ответом проходит 6 тактов. После этого, чтение происходит синхронно. Таймаут - 15 тактов для закрытия предыдущего банка и открытия следующего.

Уменьшение таймингов на 2 единицы приводит к увеличению производительности на 40%.

```
VEN\_14E4     &Dev\_1633            &SuBSYS\_011E1025
Производитель ID устройства       Реализация устройства
```
```
| TP   |  Vendor  | Device | SuBSYS |
| WLAN | 14E4     | 1633   | 
```

*Заметки по поводу первой практической*

Системная шина - самая важная величина, так как все устройства работают с этой частотой

Основное оборудование, для которого нужно искать драйвера:
- Сетевая
- Аудио
- Видео
- WLAN
- Картридер

## Администрирование компьютерных систем

Основные блоки предмета Операционные Системы
- Администрирование и управление операционной системы
- Программирование ядра системы (универ) E системное программирование

### Командные интерпретаторы Windows

Windows:
- Полностью написана Microsoft (Windows 3.11 - Windows ME)
- Принимали участие Microsoft

- NT ~1988 (Microsoft E IBM) - идея создать алтернативу Unix
- Разрабатывалась OS/2 (IBM + Microsoft + Д. Катлер) для процессоров RISC с микроядерной архитектуры с использованием кодов Mach.
- OS/2 v3.0 [1993] Уход Microsoft из IBM; IBM забрали исходники.
- Windows New Technologies; 3.0-4.x - микроядерная архитектура.; 3-4 - микроядерная архитектура.
- Windows NT - монолитно-гибридное ядро
- Windows 5.0 - Windows Server (2000, 2003), XP гибридное ядро; Впервые совместили бытовую и профессиональную версии.
- Windows 6.0 - Windows (Vista, 7), Windows Server 2008
- Windows 6.1 - Windows 2008 Server R2 [Один из самых удачных серверов]; Отказались от x32
- Windows 6.2 - Windows 8.1, Windows Server 2012; Отказались от дальнейшей нумерации ядра и версий; Вернулись к RISC + CISC
- Windows 10

Административные консоли:
- mms консоль (Панель управления -> Администрирование) - Можно самостоятельно составлять набор интерфейсов
- wmi (Windows Management Interface) - PowerShell - Полноценная объектно-ориентированная скриптовая оболочка: (JS+VBS), входят в состав ядра; PowerShell запрещяет их исполнение вне себя.
- cmd
- Графическая консоль

Команды интерпретатора CMD:
- help - Список всех доступнх команд
 - command /? - Вывести помощь по команде
- cd (ChDir) - 
  - cd .., cd ... - В родительскую директорию
  - cd \\ - В корень
  - cd dirname
  - cd "dir name"
- dir - Отобразить содержимое директории
- copy <source> <destination> - Скопировать
  - \*.\* - Все файлы
  - \* - Все файлы и папки
  - ? - Один символ
- xcopy - Скопировать с атрибутами [Не работает в консоли восстановления]
- move - Перемещение/переименование [Не работает в консоли восстановления]
- md (MkDir) <name> - Создать директорию
- rd (RmDir) <name> - Удалить директорию
- del (DELete) <name> - Удалить
- cls - Очистить экран
- ren (REName) - Переименовать
- **Ремонтные конманды**
  - ChkDSK - Проверяет содержимое диска на ошибки
    - /P - Автоматически исправляет ошибки (Консоль восстановления)
    - /f - ^, но для консоли Windows
    - <disk>:\ - Проверка конкретного диска
  - FixBoot <disk?> - Исправляет загрузчик [До 5-го ядра]
  - FixMBR - Исправляет MBR разметку
- Expand - Работает с CAB архивами

> POSIX ("позикс") - Portation Operating System Interface

Перед выполнение команды SET, нужно разрешить её выполнение в политиках

bootrec (win7+):
- boot/bootrec.exe
- /fixmbr
- /fixboot
- Восстанавливает существующие

bootsect:
- /nt60 (win7; 50 - xp)
- /ntXX DRIVE:\
- Вместо C:\ можно написать SYS (авто)
- Создание нового загрузочного раздела


bootrec /SeanOs
bootrec /RebuildBCD

Работа с vmdk

## Перенос системных файлов в Windows

- Documents and Settings
  - %UserProfile%
    - TEMP
    - Desktop
    - Documents
- Program Files
- Windows
  - TEMP
- %UserProfile%

Команды для управления реестром:
- REG (console)
- regedit (GUI)

BAT:
```
mkdir D:\Home\Desktop
mkdir D:\Home\Documents

xcopy %UserProfile%\Desktop D:\Home\Desktop /s /e /y
xcopy %UserProfile%\Documents D:\Home\Documents /s /e /y

REG ADD "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders" /v Desktop /t REG_SZ /d "D:\Home\Desktop" /f
REG ADD "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders" /v Documents /t REG_SZ /d "D:\Home\Documents" /f
```


## Реестр Windows

Предшественниками реестра были и остаются конфигурационные файлы:
- .cfg
- .config
- .ini - Файл инициализации

3 Главных .ini файла Windows:
- system.ini
- win.ini
- winfile.ini

Появление реестра обусловлено:
- Необходимостью централизованного сбора всех настроек системы в одном месте
- С базой данных проще работать
- Легко организовать многопользовательскую среду
- Реестр позволяет использовать технологию Plug-and-Play (автоматическая настройка оборудование), так как информация про оборудования хранится в ветке реестра

Реестр хранится в .dat файлах (изначально reg.dat).
Сейчас эти 5 базовых файлов, в которых хранятся ветки реестра, находятся в папке system32:
1. HKEY\_CLASSES\_ROOT - Зарегистрированные расширения файлов, ActiveX элементы
2. HKEY\_CURRENT\_USER - Ветка пользователя, работающего в системе в данный момент
3. HKEY\_LOCAL\_MACHINE - Информация про оборудование без привязки к пользователю
  - Software\\Classes - Копия HKEY\_CLASSES\_ROOT
4. HKEY\_USERS - Профили всех пользователей, HKEY\_CURRENT\_USER ссылкается на поветку этого пользователя во время его входа. Пользователь получает длинный ID
  - Default
5. HKEY\_CURRENT\_CONFIG - Настройки устройств данного сеанса, данные получает из HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\HardwareProfil....
  - %SystemRoot%\\System32\\Config

Начиная с Windows Vista, существует ветка, в которой хранится информация о производительности системы

Запись в реестре: name  type  value

Каждый параметр реестра имеет имя, значение и тип значения:
- REG\_BINARY - Бинарные данные в HEX
- REG\_DWORD - Integer
  - Представления:
    - Bin
    - Dec
    - Hex
  - Обычно работает в Boolean-режиме
  - Значения:
    - x32
    - x64
- REG\_EXPAND\_SZ - Расширенная строка
  - Используется для ссылок на файлы
  - Так же, может содержать системные переменные (%%)
  - Переменные:
    - %SystemRoot%
    - %WinDir% - Windows
    - %SystemDrive%
    - %UserProfile%
    - %ProgramFiles%
    - %UserName%
    - %ComputerName% - Имя в сети
- REG\_MULTI\_SZ - Многострочное значение (списки)
- REG\_SZ - Текстовая строка

Редактирование реестра:
- REG
- regedit

Структура реестра атомарная

> Улий - объединение веток.

Список улиев с ветками реестра:
- %SystemDrive%
  - Boot
    - [File] BCD
- %SystemRoot%
  - System32
    - Config
      - [Улий] SAM (Security Account Manager) [Зашифрован]


Благодаря атомарной структуре (распылённой), улии легко восстанавливаются, и гарантируется отсутствие неправильных значений.

Структура .reg файла:
```
Windows Registry Editor Version 5.0
[HKEY_CURRENT_USER\Software\Test] # Добавление раздела Test
<<MyName>> = "Viktor"
<<MyAge>>  = dword:00000008 # 32-битное число 8 в HEX
[-HKEY_CURRENT_USER\Software\Test] # Удаление раздела Test
```

- [...] - Обращение к разделу


## Права на файлы в NTFS

> Права заложены в файловой системе.

> Если файлы с правами скопировать из NTFS в FAT - права потеряются

> В системе присутствуют 2 главных носителя прав: **группа** и **учётная запись**

> Главным носителем прав являет сягруппа, а учётная запись, всего лишь, наследует права группы

> Учётную запись можно одновременно помещать в несколько групп

> Все наборы прав контролируются файловой системой

> В свойствая любых файлов и папок присутствуют 2 главные закладки: доступ (сетевые права) и безопасность (локальные права)

> В случае, если права на объект исключительно принадлежат конкретному пользователю, единственный способ его вернуть - стать администратором и назначить себя владельцем этого объекта.

Базовые атрибуты (~ пользователя):
- Запись
- Чтение
- Выполнение (Для папки - разрешение на открытие)

> Аудит - контроль над управлением правами папки
